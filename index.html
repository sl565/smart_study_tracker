<html>
<head>
    <style>
        div#content {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        input, textarea, button {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
        }

        .statistics {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="content">
        <div id="wrapper">
            <h3>개인화된 학습 진도 추적기</h3>
        </div>
    </div>

    <center>
        <div class="form-group">
            <label for="learning-goal">학습 목표:</label>
            <input id="learning-goal" type="text" placeholder="예: TOEIC 900점 달성" />
        </div>
        <div class="form-group">
            <label for="subject">과목:</label>
            <input id="subject" type="text" placeholder="예: 영어, 수학, 과학" />
        </div>
        <div class="form-group">
            <label for="study-time">오늘의 학습 시간 (분):</label>
            <input id="study-time" type="number" min="0" />
        </div>
        <div class="form-group">
            <label for="progress">진도 (%):</label>
            <input id="progress" type="number" min="0" max="100" />
        </div>
        <div class="form-group">
            <label for="target-date">목표 달성 예정일:</label>
            <input id="target-date" type="date" />
        </div>
        <button style="width:350px;" id="submit-study">학습 기록 저장</button>

        <div class="statistics">
            <h4>학습 통계</h4>
            <p>총 학습 시간: <span id="total-study-time">0</span> 분</p>
            <p>평균 일일 학습 시간: <span id="avg-study-time">0</span> 분</p>
            <p>목표 달성까지 남은 시간: <span id="remaining-time">계산 중...</span></p>
        </div>

        <br><br>
        <p>이메일을 남겨주시면 서비스가 런칭되었을 때 알림을 드리겠습니다. </p>
        <input id="submit-email" type="email" placeholder="알림을 받으실 이메일" /> <br><br>
        <p>서비스가 이렇게 되었으면 좋겠다는 조언을 해 주세요 </p>
        <textarea id="submit-advice" name="Text1" cols="40" rows="5" placeholder="서비스에 대한 조언을 남겨주세요"></textarea><br>
        <button style="width:350px;" id="submit">지금 제출! </button>
    </center>

    <div id="popup" style="display:none;">
        <h1>감사합니다. </h1>
        <p>이제는 우리는 같은 배를 탔습니다.  </p>
    </div>

    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/busy-load/dist/app.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/busy-load/dist/app.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/gh/dinoqqq/simple-popup@master/dist/jquery.simple-popup.min.js"></script>
    <link href="https://cdn.jsdelivr.net/gh/dinoqqq/simple-popup@master/dist/jquery.simple-popup.min.css" rel="stylesheet" type="text/css" />

    <script>
        let studyRecords = [];

        function updateStatistics() {
            const totalTime = studyRecords.reduce((sum, record) => sum + parseInt(record.studyTime), 0);
            const avgTime = studyRecords.length > 0 ? totalTime / studyRecords.length : 0;

            $('#total-study-time').text(totalTime);
            $('#avg-study-time').text(avgTime.toFixed(2));

            const targetDate = new Date($('#target-date').val());
            const today = new Date();
            const daysRemaining = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
            
            if (daysRemaining > 0) {
                $('#remaining-time').text(`${daysRemaining} 일`);
            } else {
                $('#remaining-time').text('목표일이 지났습니다.');
            }
        }

        $("#submit-study").on("click", function () {
            $.busyLoadFull("show");

            const learningGoal = $("#learning-goal").val();
            const subject = $("#subject").val();
            const studyTime = $("#study-time").val();
            const progress = $("#progress").val();
            const targetDate = $("#target-date").val();

            if (learningGoal == '' || subject == '' || studyTime == '' || progress == '' || targetDate == '') {
                alert("모든 필드를 채워주세요.");
                $.busyLoadFull("hide");
                return;
            }

            var studyData = JSON.stringify({
                "id": "study_" + new Date().getTime(),
                "learningGoal": learningGoal,
                "subject": subject,
                "studyTime": studyTime,
                "progress": progress,
                "targetDate": targetDate,
                "date": new Date().toISOString().split('T')[0]
            })

            axios.get('https://script.google.com/macros/s/AKfycbxF-iVXC7psov68UrzPMl3hXpl9QnYHzbGj7qvvUcf3jIkAfuQqB3eFNmURZ5ynys8/exec?action=insert&table=study_progress&data=' + studyData)
                .then(response => {
                    console.log(response.data.data);
                    $.busyLoadFull("hide");
                    alert("학습 기록이 저장되었습니다.");
                    
                    studyRecords.push({studyTime: studyTime});
                    updateStatistics();

                    $('#learning-goal').val('');
                    $('#subject').val('');
                    $('#study-time').val('');
                    $('#progress').val('');
                })
        });

        $("#submit").on("click", function () {
            $.busyLoadFull("show");

            const email = $("#submit-email").val();
            const advice = $("#submit-advice").val();
    
            function validateEmail(email) {
                var re = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;
                return re.test(email);
            }
    
            if (email == '' || !validateEmail(email)) {
                alert("이메일이 유효하지 않아 알림을 드릴 수가 없습니다. ");
                return;
            }
    
            var finalData = JSON.stringify({
                "id": "getUVfromCookie()",
                "email": email,
                "advice": advice
            })
    
            axios.get('https://script.google.com/macros/s/AKfycbxF-iVXC7psov68UrzPMl3hXpl9QnYHzbGj7qvvUcf3jIkAfuQqB3eFNmURZ5ynys8/exec?action=insert&table=registration&data=' + finalData)
                .then(response => {
                    console.log(response.data.data);
                    $.busyLoadFull("hide");
                    $.fn.simplePopup({ type: "html", htmlSelector: "#popup" });
                    $('#submit-email').val('');
                    $('#submit-advice').val('');
                })
        });

        function getUVfromCookie() {
            // 실제 구현 필요
            return "user_" + new Date().getTime();
        }

        function getTimeStamp() {
            return new Date().toISOString();
        }

        var data = JSON.stringify({
            "id": getUVfromCookie(),
            "landingUrl": window.location.href,
            "ip": "client_ip", // 실제 구현 시 서버에서 처리
            "referer": document.referrer,
            "time_stamp": getTimeStamp(),
            "utm": "utm_source", // 실제 구현 필요
            "device": "user_device" // 실제 구현 필요
        });

        $(document).ready(function () {
            addrScript = 'https://script.google.com/macros/s/AKfycbxF-iVXC7psov68UrzPMl3hXpl9QnYHzbGj7qvvUcf3jIkAfuQqB3eFNmURZ5ynys8/exec';

            axios.get(addrScript+'?action=insert&table=visitor&data='+data)
                .then(response => {
                    console.log(JSON.stringify(response));
                    $('<div id="result" style="font-size:10px; width:200px; word-wrap: break-word; text-overflow: ellipsis; overflow:hidden"></div>').appendTo('#wrapper');
                    $('#result').text(JSON.stringify(response));
                })

            // 페이지 로드 시 학습 기록 가져오기
            axios.get(addrScript+'?action=read&table=study_progress')
                .then(response => {
                    studyRecords = response.data.data;
                    updateStatistics();
                });
        });
    </script>
</body>
</html>